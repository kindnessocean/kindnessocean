version: '3'

volumes:
  zookeeper-data:
    driver: local
  zookeeper-log:
    driver: local
  kafka-data:
    driver: local
  redis:
    driver: local
  elasticsearch-data:
    driver: local

services:

  kindness_ocean_postgresql:
    container_name: kindness_ocean_postgresql
    image: postgres:10
    #    restart: always
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=kindness_ocean
    ports:
      - '5432:5432'

  kindness_ocean_afhq:
    container_name: kindness_ocean_akhq
    #    restart: always
    # build:
    #   context: .
    image: tchiotludo/akhq:0.19.0
    environment:
      AKHQ_CONFIGURATION: |
        akhq:
          connections:
            docker-kafka-server:
              properties:
                bootstrap.servers: "kindness_ocean_kafka:9092"
              schema-registry:
                url: "http://schema-registry:8085"
              connect:
                - name: "connect"
                  url: "http://connect:8083"

    ports:
      - 8085:8080
    depends_on:
      - kindness_ocean_zookeeper
      - kindness_ocean_kafka

  kindness_ocean_zookeeper:
    container_name: kindness_ocean_zookeeper
    #    restart: always
    image: confluentinc/cp-zookeeper
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data:Z
      - zookeeper-log:/var/lib/zookeeper/log:Z
    environment:
      ZOOKEEPER_CLIENT_PORT: '2181'
      ZOOKEEPER_ADMIN_ENABLE_SERVER: 'false'

  kindness_ocean_kafka:
    container_name: kindness_ocean_kafka
    ports:
      - 9094:9094
      - 9092:9092
    image: confluentinc/cp-kafka
    volumes:
      - kafka-data:/var/lib/kafka/data:Z
    environment:
      KAFKA_BROKER_ID: '0'
      KAFKA_ZOOKEEPER_CONNECT: 'kindness_ocean_zookeeper:2181'
      KAFKA_NUM_PARTITIONS: '12'
      KAFKA_COMPRESSION_TYPE: 'gzip'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: '1'
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: '1'
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: '1'
      #KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092


      KAFKA_LISTENERS: INTERNAL://kindness_ocean_kafka:9092,OUTSIDE://kindness_ocean_kafka:9094
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kindness_ocean_kafka:9092,OUTSIDE://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,OUTSIDE:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      KAFKA_CONFLUENT_SUPPORT_METRICS_ENABLE: 'false'
      KAFKA_JMX_PORT: '9091'
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_AUTHORIZER_CLASS_NAME: 'kafka.security.authorizer.AclAuthorizer'
      KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: 'true'
    links:
      - kindness_ocean_zookeeper
    depends_on:
      - kindness_ocean_zookeeper